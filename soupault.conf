### Configuration file for the soupault website generator ###

## Global settings

[settings]
  verbose = true
  debug = true

#  strict = false

  # Where generated files go
  build_dir = "build/"

  # Where page files are stored
  site_dir = "site/"

  # Where in the template the page content is inserted
  content_selector = "#content"

  default_template = "templates/main.html"

  # Page considered the section index
  index_page = "index"

  page_file_extensions = ["html", "inc", "md"]

  doctype = "<!DOCTYPE html>"

[preprocessors]
  md = "cmark"


## Plugin loading
[plugins]

[plugins.git-timestamp]
  file = "plugins/git-timestamp.lua"

[plugins.section-link-highlight]
  file = "plugins/section-link-highlight.lua"

## Autogenerated section index settings
[index]
  index = true
  use_default_view = false
  dump_json = "index.json"

  index_date_selector = "#revision"

[index.custom_fields]
  category = { selector = "#category", default = "Misc" }

[index.views.simple]
  index_selector = "#index"
  index_item_template = "<li> <a href=\"{{url}}\">{{{title}}}</a> </li>"

[index.views.topical]
  index_selector = "#topical-index"
  index_processor = "scripts/topical-index.py"

## Widgets

[widgets]

# Takes the content of the first <h1> and inserts it into the <title>
[widgets.page-title]
  widget = "title"
  selector = "h1"
  default = "Daniil Baturin"
  append = " &mdash; Daniil Baturin"

# Simply inserts contents of templates/sections.inc into <div id="nav">
[widgets.nav-menu]
  widget = "include"
  selector = "div#nav"
  file = "templates/sections.inc"

# Highlights the link to the current section in the navigation menu
[widgets.section-link-highlight]
  after = "nav-menu"
  widget = "section-link-highlight"

  active_link_class = "nav-active"
  selector = "div#nav"

[widgets.last-modified]
  exclude_path_regex = "(.*)/index.inc"
  exclude_page = ["misc/blank-page.inc"]
  widget = "git-timestamp"
  timestamp_container_selector = "div#content"
  manual_timestamp_selector = "time#last-modified"
  timestamp_format = '<div id="revision">This page was last modified: %s</div>'

# Generates breadcrumbs and inserts them into <div id="breadcrumbs">
[widgets.breadcrumbs]
  widget = "breadcrumbs"
  selector = "div#breadcrumbs"
  prepend = ".. / "
  append = " /"
  between = " / "
  breadcrumb_template = "<a class=\"nav\"></a>"
  min_depth = 1

# Removes the breadcrumbs div if previous widget left it empty
[widgets.breadcrumbs-cleanup]
  widget = "delete_element"
  selector = "div#breadcrumbs"
  only_if_empty = true

  # Must run after breadcrumbs!
  after = "breadcrumbs"

# Moves all elements with class="footnote" to <div id="footnotes"> 
# and replaces them with numbered links.
[widgets.footnotes]
  widget = "footnotes"
  selector = "div#footnotes"
  footnote_selector = ".footnote"
  footnote_link_class = "footnote"
  back_links = true
  link_id_prepend = "footnote-"
  back_link_id_append = "-ref"

# Inserts a table of contents generated from page headings
[widgets.table-of-contents]
  #exclude_path_regex = '/index(.*)'

  widget = "toc"
  selector = "#generated-toc"

  min_level = 2

  toc_list_class = "toc"
  toc_class_levels = false

  numbered_list = true

  heading_links = true
  heading_link_text = "â†’ "
  heading_link_class = "here"

  use_heading_slug = true

# Runs the content of <* class="language-*"> elements through a syntax highlighter
[widgets.highlight]
  widget = "preprocess_element"
  selector = '*[class^="language-"]'
  command = 'highlight -O html -f --syntax=$(echo $ATTR_CLASS | sed -e "s/language-//")'
  action = "replace_content"

## Page-specific overrides

# Explicitly limit the news script to the global index page
[widgets.site-news]
  page = "index.inc"

  widget = "exec"
  command = "scripts/git-news"
  selector = "#content"

# Include bnfgen.js only in /tools/bnfgen
# No other page needs it, and it's quite a sizeable chunk of JS
[widgets.bnfgen-script]
  path_regex = 'tools/bnfgen.(\.*)'

  widget = "insert_html"
  selector = "div#content"
  html = '<script src="/scripts/bnfgen.js"> </script> <noscript>You need JavaScript for the online version of BNFGen to work!</noscript>'
  action = "prepend_child"

[widgets.goatcounter]
  widget = 'insert_html'
  html = '<script data-goatcounter="https://dmbaturin.goatcounter.com/count" async="async" src="//gc.zgo.at/count.js"></script>'
  profile = 'live'
  selector = 'body'
  action = 'append_child'
